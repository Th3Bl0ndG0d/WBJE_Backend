sequenceDiagram
    autonumber

    actor Client
    participant JobController
    participant AuthFilter as Auth/Role Check
    participant JobService
    participant CylinderService
    participant PlateService
    participant JobRepository
    participant CylinderRepository
    participant PlateRepository
    participant JobDTOMapper

%% =================================================
%% 1) Happy flow
%% =================================================
    Client->>JobController: GET /jobs/{id} (token)
    activate JobController

    JobController->>AuthFilter: validateTokenAndRole(token)
    activate AuthFilter
    AuthFilter-->>JobController: OK
    deactivate AuthFilter

    JobController->>JobService: getJobById(id)
    activate JobService

    JobService->>JobRepository: findById(id)
    activate JobRepository
    JobRepository-->>JobService: JobEntity
    deactivate JobRepository

    JobService->>CylinderService: getCylindersByJobId(jobId)
    activate CylinderService
    CylinderService->>CylinderRepository: findAllByJobId(jobId)
    activate CylinderRepository
    CylinderRepository-->>CylinderService: cylinders[]
    deactivate CylinderRepository
    CylinderService-->>JobService: cylinders[]
    deactivate CylinderService

    loop For each cylinder in cylinders[]
        JobService->>PlateService: getPlatesByCylinderId(cylinderId)
        activate PlateService
        PlateService->>PlateRepository: findAllByCylinderId(cylinderId)
        activate PlateRepository
        PlateRepository-->>PlateService: plates[]
        deactivate PlateRepository
        PlateService-->>JobService: plates[]
        deactivate PlateService
    end

    Note right of JobService: Samenstellen hiërarchie\n(Job → Cylinders → Plates)\nin service-laag

    JobService->>JobDTOMapper: toResponseDTO(Job + cylinders + plates)
    activate JobDTOMapper
    JobDTOMapper-->>JobService: JobResponseDTO
    deactivate JobDTOMapper

    JobService-->>JobController: JobResponseDTO
    deactivate JobService

    JobController-->>Client: 200 OK (application/json)
    deactivate JobController

    Note right of Client: JSON response (indicatief)
    Note right of Client: { "id": 42, "jobNumber": "J-2025-001", ... }


%% =================================================
%% 2) Alternative flow: Authentication failed
%% =================================================
    alt Authentication failed
        Client->>JobController: GET /jobs/{id} (token)
        activate JobController

        JobController->>AuthFilter: validateTokenAndRole(token)
        activate AuthFilter
        AuthFilter-->>JobController: INVALID
        deactivate AuthFilter

        JobController-->>Client: 401 Unauthorized
        deactivate JobController
    end


%% =================================================
%% 3) Alternative flow: Authorization failed
%% =================================================
    alt Authorization failed
        Client->>JobController: GET /jobs/{id} (token)
        activate JobController

        JobController->>AuthFilter: validateTokenAndRole(token)
        activate AuthFilter
        AuthFilter-->>JobController: FORBIDDEN
        deactivate AuthFilter

        JobController-->>Client: 403 Forbidden
        deactivate JobController
    end


%% =================================================
%% 4) Alternative flow: Job not found
%% =================================================
    alt Job not found
        Client->>JobController: GET /jobs/{id} (token)
        activate JobController

        JobController->>AuthFilter: validateTokenAndRole(token)
        activate AuthFilter
        AuthFilter-->>JobController: OK
        deactivate AuthFilter

        JobController->>JobService: getJobById(id)
        activate JobService

        JobService->>JobRepository: findById(id)
        activate JobRepository
        JobRepository-->>JobService: empty
        deactivate JobRepository

        JobService-->>JobController: NotFoundException
        deactivate JobService

        JobController-->>Client: 404 Not Found
        deactivate JobController
    end
