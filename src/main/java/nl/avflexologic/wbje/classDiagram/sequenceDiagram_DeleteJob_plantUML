@startuml
title DELETE /jobs/{id} - Job verwijderen (incl. cylinders/plates) via services

autonumber

actor Client
participant JobController
participant "Auth/Role Check" as AuthFilter
participant JobService
participant CylinderService
participant PlateService
participant JobRepository
participant CylinderRepository
participant PlateRepository

'=================================================
' 1) Happy flow
'=================================================
Client -> JobController : DELETE /jobs/{id} (token)
activate JobController

JobController -> AuthFilter : validateTokenAndRole(token)
activate AuthFilter
AuthFilter --> JobController : OK
deactivate AuthFilter

JobController -> JobService : deleteJob(id)
activate JobService

JobService -> JobRepository : findById(id)
activate JobRepository
JobRepository --> JobService : JobEntity
deactivate JobRepository

note right of JobService
Verwijderen in één transactie (volledig of niet)
end note

JobService -> CylinderService : getCylindersByJobId(id)
activate CylinderService
CylinderService -> CylinderRepository : findAllByJobId(id)
activate CylinderRepository
CylinderRepository --> CylinderService : cylinders[]
deactivate CylinderRepository
CylinderService --> JobService : cylinders[]
deactivate CylinderService

loop For each cylinder in cylinders[]
  JobService -> PlateService : deletePlatesByCylinderId(cylinderId)
  activate PlateService
  PlateService -> PlateRepository : findAllByCylinderId(cylinderId)
  activate PlateRepository
  PlateRepository --> PlateService : plates[]
  deactivate PlateRepository

  loop For each plate in plates[]
    PlateService -> PlateRepository : deleteById(plateId)
    activate PlateRepository
    PlateRepository --> PlateService : deleted
    deactivate PlateRepository
  end

  PlateService --> JobService : plates deleted
  deactivate PlateService

  JobService -> CylinderService : deleteCylinder(cylinderId)
  activate CylinderService
  CylinderService -> CylinderRepository : deleteById(cylinderId)
  activate CylinderRepository
  CylinderRepository --> CylinderService : deleted
  deactivate CylinderRepository
  CylinderService --> JobService : cylinder deleted
  deactivate CylinderService
end

JobService -> JobRepository : deleteById(id)
activate JobRepository
JobRepository --> JobService : deleted
deactivate JobRepository

JobService --> JobController : success
deactivate JobService

JobController --> Client : 204 No Content
deactivate JobController


'=================================================
' 2) Alternative flow: Authentication failed
'=================================================
alt Authentication failed
  Client -> JobController : DELETE /jobs/{id} (token)
  activate JobController

  JobController -> AuthFilter : validateTokenAndRole(token)
  activate AuthFilter
  AuthFilter --> JobController : INVALID
  deactivate AuthFilter

  JobController --> Client : 401 Unauthorized
  deactivate JobController
end

alt Authorization failed
  Client -> JobController : DELETE /jobs/{id} (token)
  activate JobController

  JobController -> AuthFilter : validateTokenAndRole(token)
  activate AuthFilter
  AuthFilter --> JobController : FORBIDDEN
  deactivate AuthFilter

  JobController --> Client : 403 Forbidden
  deactivate JobController
end


'=================================================
' 3) Alternative flow: Job not found
'=================================================
alt Job not found
  Client -> JobController : DELETE /jobs/{id} (token)
  activate JobController

  JobController -> AuthFilter : validateTokenAndRole(token)
  activate AuthFilter
  AuthFilter --> JobController : OK
  deactivate AuthFilter

  JobController -> JobService : deleteJob(id)
  activate JobService

  JobService -> JobRepository : findById(id)
  activate JobRepository
  JobRepository --> JobService : empty
  deactivate JobRepository

  JobService --> JobController : NotFoundException
  deactivate JobService

  JobController --> Client : 404 Not Found
  deactivate JobController
end

@enduml
